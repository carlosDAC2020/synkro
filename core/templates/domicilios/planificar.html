{% extends 'base.html' %}
{% load static %}

{% block title %}Planificar Ruta - Synkro{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>
<style>
    .main-content { padding: 0 !important; height: 100vh; overflow: hidden; }
    .main-content > div { height: 100%; }
    .planificador-container { height: 100%; display: flex; overflow: hidden; }
    #panel-control { width: 450px; background: var(--white-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; z-index: 100; overflow-y: auto; }
    .panel-header { padding: 24px; border-bottom: 1px solid var(--border-color); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .panel-content { padding: 24px; flex-grow: 1; }
    #mapa { flex-grow: 1; height: 100%; }
    #ventas-container { max-height: 400px; overflow-y: auto; padding-right: 10px; }
    .venta-item { background: var(--white-bg); border: 2px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 12px; transition: all 0.2s ease; cursor: pointer; }
    .venta-item:hover { border-color: var(--primary-color); box-shadow: var(--shadow-md); transform: translateY(-2px); }
    .venta-item.selected { border-color: var(--primary-dark); background-color: #eef2ff; box-shadow: var(--shadow-md); }
    .venta-item input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
    .priority { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
    .priority.alta { background: #ff6b6b; color: white; }
    .priority.media { background: #ffd93d; color: #333; }
    .priority.baja { background: #6bcf7f; color: white; }
    .stats-card { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 15px; border-radius: 8px; text-align: center; }
    .stats-number { font-size: 28px; font-weight: bold; color: var(--primary-color); }
    .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px 30px; border-radius: 10px; box-shadow: var(--shadow-lg); display: none; z-index: 2000; }
    .loading.visible { display: block; }
    #plan-cargue-container { max-height: 400px; overflow-y: auto; }
    .cargue-item { background: #f8f9fa; border-left: 4px solid var(--primary-color); padding: 12px; margin-bottom: 10px; border-radius: 4px; }
    .custom-marker {
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        color: white;
        font-weight: bold;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        border: 3px solid white;
    }

    .marker-sucursal {
        background-color: #667eea; /* Azul/Morado */
    }

    .marker-entrega {
        background-color: #34d399; /* Verde */
    }
</style>
{% endblock %}

{% block content %}
<div class="planificador-container">
    <!-- Panel de Control -->
    <div id="panel-control">
        <div class="panel-header">
            <h4><i class="fas fa-route me-2"></i>Planificador de Rutas</h4>
            <p class="mb-0 small opacity-90">Optimizaci√≥n inteligente de entregas</p>
        </div>

        <div class="panel-content">
            <!-- Paso 1: Configuraci√≥n -->
            <div class="mb-4">
                <label class="form-label fw-bold"><span class="badge bg-primary me-1">1</span> Configuraci√≥n</label>
                
                <div class="mb-3">
                    <label for="sucursal-select" class="form-label">Sucursal de Salida</label>
                    <select id="sucursal-select" class="form-select">
                        {% for sucursal in sucursales %}
                        <option value="{{ sucursal.id }}" data-lat="{{ sucursal.latitud }}" data-lng="{{ sucursal.longitud }}">
                            {{ sucursal.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="repartidor-select" class="form-label">Repartidor</label>
                    <select id="repartidor-select" class="form-select" required>
                        <option value="" disabled selected>Selecciona un repartidor</option>
                        {% for repartidor in repartidores %}
                        <option 
                            value="{{ repartidor.id }}" 
                            data-capacidad-kg="{{ repartidor.capacidad_maxima_kg|stringformat:"f" }}"
                            data-capacidad-m3="{{ repartidor.capacidad_maxima_m3|stringformat:"f" }}">
                            {{ repartidor.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- INICIO: Bloque de visualizaci√≥n de capacidad y carga -->
                <div id="capacidad-info" class="mb-3" style="display: none;">
                    <div class="d-flex justify-content-between small">
                        <span>Capacidad del Veh√≠culo</span>
                        <span id="capacidad-vehiculo" class="fw-bold"></span>
                    </div>
                    <div class="progress" style="height: 12px;" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        <div id="carga-progreso" class="progress-bar bg-success" style="width: 0%;"></div>
                    </div>
                    <div class="d-flex justify-content-between small mt-1">
                        <span>Carga Actual</span>
                        <span id="carga-actual" class="fw-bold">0 kg</span>
                    </div>
                </div>
                <!-- FIN: Bloque de visualizaci√≥n de capacidad y carga -->
                
                <div class="mb-3">
                    <label for="fecha-entrega" class="form-label">Fecha de Entrega</label>
                    <input type="date" id="fecha-entrega" class="form-control" required>
                </div>
                
                <div class="row g-2">
                    <div class="col">
                        <div class="stats-card">
                            <div class="stats-number" id="total-ventas">0</div>
                            <div class="small">Pendientes</div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="stats-card">
                            <div class="stats-number" id="total-seleccionadas">0</div>
                            <div class="small">Seleccionadas</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Paso 2: Ventas -->
            <div class="mb-4">
                <label class="form-label fw-bold"><span class="badge bg-primary me-1">2</span> Ventas a Incluir</label>
                <div id="ventas-container">
                    <div class="text-center py-3 text-muted">
                        <i class="fas fa-spinner fa-spin"></i> Cargando ventas...
                    </div>
                </div>
            </div>

            <!-- Paso 3: Acciones -->
            <div class="mb-4">
                <label class="form-label fw-bold"><span class="badge bg-primary me-1">3</span> Acciones</label>
                <div class="d-grid gap-2">
                    <button id="calcular-btn" class="btn btn-primary btn-lg" disabled>
                        <i class="fas fa-calculator me-2"></i>Calcular Ruta √ìptima
                    </button>
                    <button id="guardar-btn" class="btn btn-success" disabled>
                        <i class="fas fa-save me-2"></i>Guardar Ruta
                    </button>
                    <a href="{% url 'domicilios_home' %}" class="btn btn-secondary">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </a>
                </div>
            </div>

            <!-- Resumen de Ruta -->
            <div id="resumen-ruta" class="card bg-light" style="display: none;">
                <div class="card-body">
                    <h5 class="card-title text-success"><i class="fas fa-chart-line me-2"></i>Resumen de Ruta</h5>
                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <div class="fw-bold fs-5" id="distancia">-</div>
                            <div class="small text-muted">Distancia</div>
                        </div>
                        <div class="col-6">
                            <div class="fw-bold fs-5" id="tiempo">-</div>
                            <div class="small text-muted">Tiempo</div>
                        </div>
                    </div>
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="fw-bold fs-5" id="paradas">-</div>
                            <div class="small text-muted">Paradas</div>
                        </div>
                        <div class="col-6">
                            <div class="fw-bold fs-5" id="peso-total">-</div>
                            <div class="small text-muted">Peso Total</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Plan de Cargue LIFO -->
            <div id="plan-cargue-section" style="display: none;">
                <hr>
                <h5 class="mb-3"><i class="fas fa-boxes me-2"></i>Plan de Cargue (LIFO)</h5>
                <div id="plan-cargue-container"></div>
            </div>
        </div>
    </div>

    <!-- Mapa -->
    <div id="mapa"></div>
    
    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner-border text-primary mb-2" role="status"></div>
        <div>Calculando ruta √≥ptima...</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
// ===== SOLUCI√ìN COMPLETA: REEMPLAZAR TODAS LAS FUNCIONES EN EL TEMPLATE =====

document.addEventListener('DOMContentLoaded', function() {
    // --- VARIABLES GLOBALES ---
    let mapa, ventasPendientes = [], rutaCalculada = null;
    const sucursalSelect = document.getElementById('sucursal-select');
    const repartidorSelect = document.getElementById('repartidor-select');
    const fechaInput = document.getElementById('fecha-entrega');
    const calcularBtn = document.getElementById('calcular-btn');
    const guardarBtn = document.getElementById('guardar-btn');
    let capaRuta = null;
    
    // --- INICIALIZACI√ìN DEL MAPA ---
    const selectedOption = sucursalSelect.options[sucursalSelect.selectedIndex];
    //const initialLat = parseFloat(selectedOption.dataset.lat);
    //const initialLng = parseFloat(selectedOption.dataset.lng);
    const initialLat = parseFloat(String(selectedOption.dataset.lat).replace(',', '.'));
    const initialLng = parseFloat(String(selectedOption.dataset.lng).replace(',', '.'));

    
    mapa = L.map('mapa').setView([initialLat, initialLng], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(mapa);
    
    let marcadorSucursal = L.marker([initialLat, initialLng], {
        icon: L.divIcon({
            html: '<div style="background: #667eea; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"><i class="fas fa-store"></i></div>',
            className: '',
            iconSize: [32, 32]
        })
    }).addTo(mapa).bindPopup('<b>Sucursal de Salida</b>');
    
    const today = new Date().toISOString().split('T')[0];
    fechaInput.value = today;
    fechaInput.min = today;
    
    // --- EVENT LISTENERS ---
    sucursalSelect.addEventListener('change', handleSucursalChange);
    repartidorSelect.addEventListener('change', handleRepartidorChange);
    calcularBtn.addEventListener('click', handleCalcularRuta);
    guardarBtn.addEventListener('click', handleGuardarRuta);

    // --- CARGA INICIAL ---
    cargarVentasPendientes();

    // ========== FUNCIONES PRINCIPALES ==========

    function handleSucursalChange() {
        const option = this.options[this.selectedIndex];
        //const lat = parseFloat(option.dataset.lat);
        //const lng = parseFloat(option.dataset.lng);
        const lat = parseFloat(String(option.dataset.lat).replace(',', '.'));
        const lng = parseFloat(String(option.dataset.lng).replace(',', '.'));
        
        mapa.removeLayer(marcadorSucursal);
        marcadorSucursal = L.marker([lat, lng], {
            icon: L.divIcon({
                html: '<div style="background: #667eea; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"><i class="fas fa-store"></i></div>',
                className: '',
                iconSize: [32, 32]
            })
        }).addTo(mapa).bindPopup('<b>Sucursal de Salida</b>');
        mapa.setView([lat, lng], 13);
    }

    function handleRepartidorChange() {
        actualizarInfoCapacidad();
        actualizarEstadisticas();
    }
    
    async function cargarVentasPendientes() {
        try {
            const response = await fetch('{% url "api_ventas_pendientes" %}');
            const data = await response.json();
            ventasPendientes = data.ventas;
            console.log(`üì¶ Ventas pendientes cargadas: ${ventasPendientes.length}`);
            renderizarVentas();
        } catch (error) {
            console.error('‚ùå Error cargando ventas:', error);
            document.getElementById('ventas-container').innerHTML = '<div class="alert alert-danger">Error al cargar ventas</div>';
        }
    }
    
    function renderizarVentas() {
        const container = document.getElementById('ventas-container');
        if (ventasPendientes.length === 0) {
            container.innerHTML = '<div class="text-center py-3 text-muted">No hay ventas pendientes de domicilio</div>';
            return;
        }
        
        container.innerHTML = '';
        ventasPendientes.forEach((venta, index) => {
            const item = document.createElement('div');
            item.className = 'venta-item';
            item.dataset.ventaId = venta.id;

            let ventanaTiempoHTML = '';
            if (venta.ventana_inicio && venta.ventana_fin) {
                ventanaTiempoHTML = `<span class="badge text-bg-secondary ms-2"><i class="fas fa-clock me-1"></i>${venta.ventana_inicio} - ${venta.ventana_fin}</span>`;
            }

            item.innerHTML = `
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <span class="badge bg-primary me-2">#${venta.id}</span>
                        <span class="priority ${venta.prioridad}">${venta.prioridad.toUpperCase()}</span>
                        ${ventanaTiempoHTML}
                    </div>
                    <input type="checkbox" class="form-check-input" value="${venta.id}" data-index="${index}">
                </div>
                <div class="fw-bold">${venta.cliente}</div>
                <div class="small text-muted">${venta.direccion}</div>
                <div class="small mt-2">
                    <i class="fas fa-box me-1"></i>${venta.productos.length} producto(s)
                    <i class="fas fa-weight-hanging ms-2 me-1"></i>${venta.peso_total_kg.toFixed(2)} kg
                </div>
            `;
            
            const checkbox = item.querySelector('input[type="checkbox"]');
            
            // Evento para todo el item (excepto el checkbox)
            item.addEventListener('click', function(e) {
                // Si el click es en el checkbox mismo, no hacer nada (dejarlo manejar su propio evento)
                if (e.target === checkbox) return;
                
                // Toggle del checkbox
                checkbox.checked = !checkbox.checked;
                item.classList.toggle('selected', checkbox.checked);
                
                console.log(`${checkbox.checked ? '‚úÖ Seleccionada' : '‚ùå Deseleccionada'} venta #${venta.id}`);
                
                actualizarBarraDeCarga();
                actualizarEstadisticas();
            });
            
            // Evento espec√≠fico del checkbox
            checkbox.addEventListener('change', function(e) {
                item.classList.toggle('selected', this.checked);
                console.log(`${this.checked ? '‚úÖ Seleccionada' : '‚ùå Deseleccionada'} venta #${venta.id} (checkbox)`);
                actualizarBarraDeCarga();
                actualizarEstadisticas();
            });
            
            container.appendChild(item);
        });
        
        console.log(`‚úÖ ${ventasPendientes.length} ventas renderizadas`);
        actualizarEstadisticas();
    }
    
    function actualizarInfoCapacidad() {
        const selectedRepartidor = repartidorSelect.options[repartidorSelect.selectedIndex];
        const capacidadInfoDiv = document.getElementById('capacidad-info');
        
        if (selectedRepartidor && selectedRepartidor.value) {
            const capacidadKg = parseFloat(selectedRepartidor.dataset.capacidadKg);
            document.getElementById('capacidad-vehiculo').textContent = `${capacidadKg.toFixed(2)} kg`;
            capacidadInfoDiv.style.display = 'block';
            actualizarBarraDeCarga();
        } else {
            capacidadInfoDiv.style.display = 'none';
        }
    }

    function actualizarBarraDeCarga() {
        const selectedRepartidor = repartidorSelect.options[repartidorSelect.selectedIndex];
        if (!selectedRepartidor || !selectedRepartidor.value) return 0;

        const capacidadKg = parseFloat(selectedRepartidor.dataset.capacidadKg);
        const checkboxes = document.querySelectorAll('#ventas-container input[type="checkbox"]:checked');
        let cargaTotalKg = 0;

        console.log(`‚öñÔ∏è Calculando carga: ${checkboxes.length} ventas seleccionadas`);

        checkboxes.forEach(cb => {
            const venta = ventasPendientes.find(v => v.id == cb.value);
            if (venta) {
                cargaTotalKg += venta.peso_total_kg;
                console.log(`  - Venta #${venta.id}: ${venta.peso_total_kg} kg`);
            }
        });
        
        console.log(`  üìä Total: ${cargaTotalKg.toFixed(2)} kg / ${capacidadKg} kg`);
        
        document.getElementById('carga-actual').textContent = `${cargaTotalKg.toFixed(2)} kg`;

        const porcentajeCarga = capacidadKg > 0 ? (cargaTotalKg / capacidadKg) * 100 : 0;
        const barraProgreso = document.getElementById('carga-progreso');
        barraProgreso.style.width = `${Math.min(porcentajeCarga, 100)}%`;
        barraProgreso.parentElement.setAttribute('aria-valuenow', porcentajeCarga);
        
        barraProgreso.classList.remove('bg-success', 'bg-warning', 'bg-danger');
        document.getElementById('carga-actual').classList.remove('text-danger');

        if (porcentajeCarga > 100) {
            barraProgreso.classList.add('bg-danger');
            document.getElementById('carga-actual').classList.add('text-danger');
        } else if (porcentajeCarga > 85) {
            barraProgreso.classList.add('bg-warning');
        } else {
            barraProgreso.classList.add('bg-success');
        }
        return cargaTotalKg;
    }

    function actualizarEstadisticas() {
        const checkboxes = document.querySelectorAll('#ventas-container input[type="checkbox"]:checked');
        const seleccionadasCount = checkboxes.length;
        const repartidorSeleccionado = !!repartidorSelect.value;
        
        console.log(`üìä Estad√≠sticas: ${seleccionadasCount} seleccionadas de ${ventasPendientes.length}`);
        
        const cargaTotal = actualizarBarraDeCarga();
        const option = repartidorSelect.options[repartidorSelect.selectedIndex];
        const capacidad = option && option.value ? parseFloat(option.dataset.capacidadKg) : 0;
        const cargaExcedida = cargaTotal > capacidad;

        document.getElementById('total-ventas').textContent = ventasPendientes.length;
        document.getElementById('total-seleccionadas').textContent = seleccionadasCount;
        
        const puedeCalcular = seleccionadasCount > 0 && repartidorSeleccionado && !cargaExcedida;
        calcularBtn.disabled = !puedeCalcular;
        
        console.log(`üéØ Puede calcular: ${puedeCalcular} (ventas: ${seleccionadasCount}, repartidor: ${repartidorSeleccionado}, excedida: ${cargaExcedida})`);
    }
    
    async function handleCalcularRuta() {
        const checkboxes = document.querySelectorAll('#ventas-container input[type="checkbox"]:checked');
        const ventasIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
        
        console.log('üöÄ ========== INICIANDO C√ÅLCULO DE RUTA ==========');
        console.log(`üì¶ Ventas seleccionadas: ${ventasIds.length}`, ventasIds);
        
        if (ventasIds.length === 0) {
            alert('‚ö†Ô∏è Debes seleccionar al menos una venta');
            return;
        }
        
        if (!repartidorSelect.value) {
            alert('‚ö†Ô∏è Debes seleccionar un repartidor');
            return;
        }
        
        if (!fechaInput.value) {
            alert('‚ö†Ô∏è Debes seleccionar una fecha de entrega');
            return;
        }
        
        document.getElementById('loading').classList.add('visible');
        
        try {
            const requestBody = {
                sucursal_id: parseInt(sucursalSelect.value),
                repartidor_id: parseInt(repartidorSelect.value),
                ventas_ids: ventasIds,
                fecha_entrega: fechaInput.value
            };
            
            console.log('üì§ Enviando solicitud:', requestBody);
            
            const response = await fetch('{% url "api_calcular_ruta" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(requestBody)
            });
            
            const data = await response.json();
            console.log('üì• Respuesta recibida:', data);
            
            if (data.success) {
                console.log('‚úÖ Ruta calculada exitosamente');
                rutaCalculada = data;
                mostrarRutaEnMapa(data);
                mostrarResumen(data);
                mostrarPlanCargue(data.plan_cargue);
                guardarBtn.disabled = false;
            } else {
                console.error('‚ùå Error en respuesta:', data.error);
                alert('Error al calcular la ruta: ' + data.error);
                rutaCalculada = null;
                guardarBtn.disabled = true;
            }
        } catch (error) {
            console.error('‚ùå Error de red:', error);
            alert('Ocurri√≥ un error inesperado al calcular la ruta.');
        } finally {
            document.getElementById('loading').classList.remove('visible');
            console.log('========== FIN C√ÅLCULO ==========');
        }
    }
    
    function mostrarRutaEnMapa(data) {
        console.log('üìç ========== RENDERIZANDO RUTA EN MAPA ==========');
        console.log('üì¶ Datos recibidos:', {
            geometria: data.ruta?.geometria?.coordinates?.length || 'NO',
            waypoints_info: data.ruta?.waypoints_info?.length || 0,
            waypoints: data.ruta?.waypoints?.length || 0
        });
        
        // 1. Limpiar capas anteriores
        if (capaRuta) {
            console.log('üßπ Limpiando capa anterior');
            mapa.removeLayer(capaRuta);
        }
        capaRuta = L.layerGroup().addTo(mapa);
        
        // 2. Validar geometr√≠a
        if (!data.ruta || !data.ruta.geometria || !data.ruta.geometria.coordinates) {
            console.error('‚ùå ERROR: No hay geometr√≠a v√°lida', data.ruta);
            alert('Error: No se recibi√≥ la geometr√≠a de la ruta');
            return;
        }
        
        const coords = data.ruta.geometria.coordinates;
        console.log(`‚úÖ Geometr√≠a v√°lida: ${coords.length} puntos`);
        console.log(`   Primer punto: [${coords[0][1]}, ${coords[0][0]}]`);
        console.log(`   √öltimo punto: [${coords[coords.length-1][1]}, ${coords[coords.length-1][0]}]`);
        
        // 3. Dibujar polyline
        const latLngs = coords.map(coord => [coord[1], coord[0]]);
        
        const polyline = L.polyline(latLngs, {
            color: '#667eea',
            weight: 6,
            opacity: 0.8,
            lineJoin: 'round',
            lineCap: 'round'
        }).addTo(capaRuta);
        
        console.log(`‚úÖ Polyline dibujada con ${latLngs.length} puntos`);
        
        // Ajustar vista
        mapa.fitBounds(polyline.getBounds().pad(0.1));
        console.log('‚úÖ Mapa ajustado a bounds');

        // 4. Dibujar marcadores
        if (!data.ruta.waypoints_info || data.ruta.waypoints_info.length === 0) {
            console.warn('‚ö†Ô∏è No hay waypoints_info');
            return;
        }
        
        console.log(`üìå Dibujando ${data.ruta.waypoints_info.length} marcadores...`);
        
        data.ruta.waypoints_info.forEach((wp, index) => {
            let iconHtml, iconClass, iconSize;
            
            if (wp.type === 'sucursal') {
                iconHtml = '<i class="fas fa-store" style="font-size: 16px;"></i>';
                iconClass = 'marker-sucursal';
                iconSize = [40, 40];
                console.log(`  üè™ Sucursal en: [${wp.lat}, ${wp.lng}]`);
            } else if (wp.type === 'entrega') {
                iconHtml = `<span style="font-size: 14px; font-weight: bold;">${wp.label}</span>`;
                iconClass = 'marker-entrega';
                iconSize = [36, 36];
                console.log(`  üì¶ Entrega #${wp.label} en: [${wp.lat}, ${wp.lng}]`);
            } else {
                console.warn(`  ‚ö†Ô∏è Tipo desconocido: ${wp.type}`);
                return;
            }

            const markerIcon = L.divIcon({
                html: `<div class="custom-marker ${iconClass}" style="width: ${iconSize[0]}px; height: ${iconSize[1]}px;">${iconHtml}</div>`,
                className: '',
                iconSize: iconSize,
                iconAnchor: [iconSize[0]/2, iconSize[1]/2]
            });

            const marker = L.marker([wp.lat, wp.lng], { icon: markerIcon })
                .addTo(capaRuta)
                .bindPopup(wp.popup);
            
            if (wp.type === 'sucursal') {
                marker.openPopup();
            }
        });
        
        console.log('‚úÖ Todos los marcadores renderizados');
        console.log('========== FIN RENDERIZADO ==========');
    }
    
    function mostrarResumen(data) {
        document.getElementById('distancia').textContent = data.ruta.distancia_km + ' km';
        document.getElementById('tiempo').textContent = data.ruta.tiempo_min + ' min';
        document.getElementById('paradas').textContent = data.numero_paradas;
        document.getElementById('peso-total').textContent = data.peso_total_kg + ' kg';
        document.getElementById('resumen-ruta').style.display = 'block';
    }
    
    function mostrarPlanCargue(plan) {
        const container = document.getElementById('plan-cargue-container');
        container.innerHTML = '';
        
        plan.forEach(item => {
            const div = document.createElement('div');
            div.className = 'cargue-item';
            div.innerHTML = `
                <div class="d-flex justify-content-between mb-2">
                    <strong>Posici√≥n de Carga #${item.orden_carga}</strong>
                    <span class="badge bg-primary">Parada de Entrega #${item.orden_entrega}</span>
                </div>
                <div class="small"><strong>${item.cliente}</strong></div>
                <div class="small text-muted">${item.direccion}</div>
                <div class="small mt-2"><i class="fas fa-weight-hanging me-1"></i>${item.peso_total_kg} kg</div>
                <div class="alert alert-warning small mt-2 mb-0 py-1">${item.instruccion}</div>
            `;
            container.appendChild(div);
        });
        document.getElementById('plan-cargue-section').style.display = 'block';
    }
    
    async function handleGuardarRuta() {
        if (!rutaCalculada) {
            alert('‚ö†Ô∏è Primero debes calcular una ruta');
            return;
        }
        
        console.log('üíæ Guardando ruta...');
        
        try {
            const response = await fetch('{% url "api_guardar_ruta" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    sucursal_id: sucursalSelect.value,
                    repartidor_id: repartidorSelect.value,
                    fecha_entrega: fechaInput.value,
                    distancia_km: rutaCalculada.ruta.distancia_km,
                    tiempo_min: rutaCalculada.ruta.tiempo_min,
                    numero_paradas: rutaCalculada.numero_paradas,
                    waypoints: rutaCalculada.ruta.waypoints,
                    geometria: rutaCalculada.ruta.geometria,
                    trafico: rutaCalculada.ruta.trafico,
                    instrucciones: rutaCalculada.ruta.instrucciones,
                    plan_cargue: rutaCalculada.plan_cargue,
                    peso_total_kg: rutaCalculada.peso_total_kg,
                    volumen_total_m3: rutaCalculada.volumen_total_m3
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('‚úÖ ' + data.message);
                window.location.href = '{% url "domicilios_home" %}';
            } else {
                alert('‚ùå Error al guardar: ' + data.error);
            }
        } catch (error) {
            console.error('‚ùå Error guardando:', error);
            alert('Ocurri√≥ un error al guardar la ruta.');
        }
    }
});
</script>
{% endblock %}
