{% extends 'base.html' %}

{% block title %}Nueva Venta - Synkro{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-plus-circle me-2"></i>Nueva Venta</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'venta_list' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Volver a ventas
        </a>
    </div>
</div>

<form method="post" id="venta-form">
    {% csrf_token %}
    
    <div class="row">
        <!-- Columna de Información de la venta -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Información de la Venta</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="{{ venta_form.cliente.id_for_label }}" class="form-label">
                            <i class="fas fa-user me-2"></i>Cliente
                        </label>
                        {{ venta_form.cliente }}
                        <small class="form-text text-muted">Opcional - Dejar vacío para cliente general</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ venta_form.estado.id_for_label }}" class="form-label">
                            <i class="fas fa-flag me-2"></i>Estado
                        </label>
                        {{ venta_form.estado }}
                    </div>
                    
                    <hr class="my-3">

                    <!-- INICIO: Sección de Domicilios -->
                    <div class="form-check mb-3">
                        {{ venta_form.requiere_domicilio }}
                        <label class="form-check-label" for="{{ venta_form.requiere_domicilio.id_for_label }}">
                           <strong>{{ venta_form.requiere_domicilio.label }}</strong>
                        </label>
                    </div>
                    
                    <!-- Contenedor para campos de domicilio que se mostrará/ocultará -->
                    <div id="campos-domicilio" style="display: none;">
                        <div class="mb-3">
                            <label for="{{ venta_form.direccion_entrega.id_for_label }}" class="form-label">{{ venta_form.direccion_entrega.label }}</label>
                            {{ venta_form.direccion_entrega }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ venta_form.prioridad_entrega.id_for_label }}" class="form-label">{{ venta_form.prioridad_entrega.label }}</label>
                            {{ venta_form.prioridad_entrega }}
                        </div>
                    
                        <!-- Ventanas de Tiempo -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ venta_form.ventana_tiempo_inicio.id_for_label }}" class="form-label">{{ venta_form.ventana_tiempo_inicio.label }}</label>
                                {{ venta_form.ventana_tiempo_inicio }}
                                <div class="form-text text-muted">{{ venta_form.ventana_tiempo_inicio.help_text }}</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ venta_form.ventana_tiempo_fin.id_for_label }}" class="form-label">{{ venta_form.ventana_tiempo_fin.label }}</label>
                                {{ venta_form.ventana_tiempo_fin }}
                                <div class="form-text text-muted">{{ venta_form.ventana_tiempo_fin.help_text }}</div>
                            </div>
                        </div>
                    </div>
                    <!-- FIN: Sección de Domicilios -->
                    
                    <!-- Resumen de totales -->
                    <div class="border-top pt-3 mt-3">
                        <h6 class="mb-3">Resumen de Pago</h6>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span id="subtotal">$0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>IVA (19%):</span>
                            <span id="iva">$0.00</span>
                        </div>
                        <div class="d-flex justify-content-between border-top pt-2">
                            <strong>Total:</strong>
                            <strong id="total">$0.00</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Columna de Productos -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Productos</h6>
                </div>
                <div class="card-body">
                    {{ formset.management_form }}
                    
                    <div id="formset-container">
                        {% for form in formset %}
                        <div class="formset-form border rounded p-3 mb-3">
                            {% if form.non_field_errors %}
                                <div class="alert alert-danger">
                                    {{ form.non_field_errors }}
                                </div>
                            {% endif %}
                            
                            <div class="row align-items-end">
                                <div class="col-md-5">
                                    <label class="form-label">Producto</label>
                                    {{ form.producto }}
                                    {% if form.producto.errors %}
                                        <div class="text-danger small">{{ form.producto.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Cantidad</label>
                                    {{ form.cantidad }}
                                    {% if form.cantidad.errors %}
                                        <div class="text-danger small">{{ form.cantidad.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Precio Unit.</label>
                                    {{ form.precio_unitario_venta }}
                                    {% if form.precio_unitario_venta.errors %}
                                        <div class="text-danger small">{{ form.precio_unitario_venta.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-2 d-flex align-items-center justify-content-end">
                                    <button type="button" class="btn btn-danger btn-sm remove-form" title="Eliminar producto">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <div class="d-none">{{ form.DELETE }}</div>
                                </div>
                            </div>
                            
                            <div class="row mt-2">
                                <div class="col-md-12">
                                    <small class="text-muted">Stock disponible: <span class="stock-info">-</span></small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <button type="button" id="add-form" class="btn btn-outline-primary">
                        <i class="fas fa-plus me-2"></i>Agregar Producto
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Botones de acción -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-end">
                <a href="{% url 'venta_list' %}" class="btn btn-secondary me-2">
                    <i class="fas fa-times me-2"></i>Cancelar
                </a>
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-check me-2"></i>Crear Venta
                </button>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- INICIO: Lógica para mostrar/ocultar campos de domicilio ---
    const checkDomicilio = document.getElementById('{{ venta_form.requiere_domicilio.id_for_label }}');
    const camposDomicilio = document.getElementById('campos-domicilio');

    function toggleCamposDomicilio() {
        if (checkDomicilio.checked) {
            camposDomicilio.style.display = 'block';
        } else {
            camposDomicilio.style.display = 'none';
        }
    }

    // Ejecutar al cargar la página y cada vez que cambie el checkbox
    toggleCamposDomicilio();
    if(checkDomicilio) {
        checkDomicilio.addEventListener('change', toggleCamposDomicilio);
    }
    // --- FIN: Lógica de domicilio ---


    // --- El resto de tu script para el formset se mantiene igual ---
    let formCount = parseInt('{{ formset.total_form_count }}');
    const maxForms = parseInt('{{ formset.max_num }}');
    let productStocks = {}; 

    function validateStock(formRow) {
        // Tu función de validación de stock existente...
        return true; // Simplificado para brevedad, pega tu código aquí
    }
    
    function updateProductPrice(selectElement) {
        const productId = selectElement.value;
        const formRow = selectElement.closest('.formset-form');
        const precioInput = formRow.querySelector('input[name$="-precio_unitario_venta"]');
        const stockInfo = formRow.querySelector('.stock-info');
        
        if (productId) {
            fetch(`/api/producto/${productId}/precio/`)
                .then(response => response.json())
                .then(data => {
                    if (data.precio) {
                        precioInput.value = data.precio.toFixed(2);
                        productStocks[productId] = data.stock;
                        stockInfo.innerHTML = `<span class="text-info">${data.stock} unidades disponibles</span>`;
                        updateTotals();
                        validateStock(formRow);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    stockInfo.innerHTML = '<span class="text-danger">Error al cargar</span>';
                });
        } else {
            precioInput.value = '';
            stockInfo.innerHTML = '<span class="text-muted">-</span>';
            updateTotals();
        }
    }
    
    function updateDeleteButtons() {
        const visibleForms = Array.from(document.querySelectorAll('.formset-form')).filter(form => form.style.display !== 'none');
        visibleForms.forEach((form, index) => {
            const deleteBtn = form.querySelector('.remove-form');
            if (deleteBtn) {
                deleteBtn.disabled = visibleForms.length <= 1;
            }
        });
    }
    
    function updateTotals() {
        let subtotal = 0;
        document.querySelectorAll('.formset-form').forEach(form => {
            const deleteInput = form.querySelector('input[name$="-DELETE"]');
            if (!deleteInput || !deleteInput.checked) {
                const cantidad = parseFloat(form.querySelector('input[name$="-cantidad"]').value) || 0;
                const precio = parseFloat(form.querySelector('input[name$="-precio_unitario_venta"]').value) || 0;
                subtotal += cantidad * precio;
            }
        });
        
        const iva = subtotal * 0.19;
        const total = subtotal + iva;
        
        document.getElementById('subtotal').textContent = `$${subtotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById('iva').textContent = `$${iva.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById('total').textContent = `$${total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }
    
    function addFormsetListeners(form) {
        form.querySelector('select[name$="-producto"]').addEventListener('change', function() {
            updateProductPrice(this);
        });
        
        form.querySelector('input[name$="-cantidad"]').addEventListener('input', () => {
            validateStock(form);
            updateTotals();
        });
        
        form.querySelector('input[name$="-precio_unitario_venta"]').addEventListener('input', updateTotals);
    }

    document.getElementById('formset-container').addEventListener('click', function(e) {
        const removeBtn = e.target.closest('.remove-form');
        if (removeBtn) {
            e.preventDefault();
            const form = removeBtn.closest('.formset-form');
            const deleteInput = form.querySelector('input[name$="-DELETE"]');
            if (deleteInput) {
                deleteInput.checked = true;
                form.style.display = 'none';
            }
            updateTotals();
            updateDeleteButtons();
        }
    });

    document.getElementById('add-form').addEventListener('click', function() {
        if (formCount >= maxForms) return;

        const container = document.getElementById('formset-container');
        const formsetForms = container.querySelectorAll('.formset-form');
        const emptyFormHtml = document.getElementById('empty-form-template')?.innerHTML;
        
        // Asumiendo que no tienes un template, clonamos el primero
        const firstForm = formsetForms[0];
        if (!firstForm) return; // No hay formularios para clonar

        const newForm = firstForm.cloneNode(true);
        
        // Limpiar y actualizar atributos
        const formRegex = new RegExp(`form-(\\d+)-`, 'g');
        newForm.innerHTML = newForm.innerHTML.replace(formRegex, `form-${formCount}-`);
        newForm.querySelectorAll('input, select, textarea').forEach(el => {
            if(el.type !== 'hidden') el.value = '';
            if(el.checked) el.checked = false;
        });
        newForm.querySelector('.stock-info').textContent = '-';
        newForm.style.display = 'block';

        const deleteInput = newForm.querySelector('input[name$="-DELETE"]');
        if(deleteInput) deleteInput.checked = false;

        container.appendChild(newForm);
        addFormsetListeners(newForm);
        
        formCount++;
        document.querySelector('input[name="detalles-TOTAL_FORMS"]').value = formCount;
        
        updateDeleteButtons();
    });

    // Añadir listeners a los formularios iniciales
    document.querySelectorAll('.formset-form').forEach(addFormsetListeners);
    
    // Calcular totales y estado de botones iniciales
    updateTotals();
    updateDeleteButtons();
});
</script>
{% endblock %}
